<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VetScan Detective - Tier-Detektiv Spiel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="animal-patients-generator.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Fredoka:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .detective-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        .value-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: center;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            margin: 8px 0;
        }
        
        .measured-value {
            text-align: center;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .normal-value {
            text-align: center;
            padding: 12px;
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid #22c55e;
            border-radius: 12px;
            color: #16a34a;
        }
        
        .value-status-good {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid #22c55e;
            color: #16a34a;
        }
        
        .value-status-warning {
            background: rgba(251, 191, 36, 0.2);
            border: 2px solid #fbbf24;
            color: #d97706;
        }
        
        .value-status-critical {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            color: #dc2626;
            animation: pulse-critical 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-critical {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .body-part-button {
            position: absolute;
            background: rgba(34, 211, 238, 0.8);
            border: 2px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse-hint 2s ease-in-out infinite;
        }
        
        .body-part-button:hover {
            transform: scale(1.2);
            background: rgba(34, 211, 238, 1);
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.6);
        }
        
        .body-part-button.examined {
            background: rgba(34, 197, 94, 0.8);
            animation: none;
        }
        
        .body-part-button.problem {
            background: rgba(239, 68, 68, 0.8);
            animation: pulse-problem 1s ease-in-out infinite;
        }
        
        @keyframes pulse-hint {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        @keyframes pulse-problem {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px 10px rgba(239, 68, 68, 0); }
        }
        
        .clue-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
            position: relative;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .diagnosis-tree {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .tree-node {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border: 2px solid #6366f1;
            border-radius: 12px;
            padding: 12px;
            margin: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tree-node:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3);
        }
        
        .tree-node.selected {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
        }
        
        .tree-node.excluded {
            opacity: 0.4;
            text-decoration: line-through;
        }
        
        .mentor-bubble {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 20px;
            padding: 16px;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: bounceIn 0.5s ease;
        }
        
        .mentor-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 30px;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 15px solid white;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .mentor-character {
            position: fixed;
            bottom: 10px;
            right: 340px;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .timeline-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 16px;
            margin: 20px 0;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            opacity: 0;
            animation: fadeInLeft 0.5s ease forwards;
        }
        
        .timeline-item:nth-child(1) { animation-delay: 0.1s; }
        .timeline-item:nth-child(2) { animation-delay: 0.2s; }
        .timeline-item:nth-child(3) { animation-delay: 0.3s; }
        
        @keyframes fadeInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .timeline-dot {
            width: 12px;
            height: 12px;
            background: #6366f1;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .timeline-line {
            position: absolute;
            left: 5px;
            top: 12px;
            bottom: 12px;
            width: 2px;
            background: #6366f1;
            opacity: 0.3;
        }
        
        .examination-checklist {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .checklist-item:hover {
            background: #f3f4f6;
        }
        
        .checklist-item.completed {
            background: rgba(34, 197, 94, 0.1);
        }
        
        .checklist-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .checklist-item.completed .checklist-checkbox {
            background: #22c55e;
            border-color: #22c55e;
        }
        
        #canvas3d {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            cursor: grab;
        }
        
        #canvas3d:active {
            cursor: grabbing;
        }
        
        .difficulty-selector {
            display: flex;
            gap: 12px;
            margin: 16px 0;
        }
        
        .difficulty-button {
            padding: 8px 20px;
            border-radius: 20px;
            border: 2px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .difficulty-button.active {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border-color: #6366f1;
        }
        
        .info-tooltip {
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.875em;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .info-tooltip.show {
            opacity: 1;
        }
        
        .info-tooltip::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #1f2937;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen p-4">
        <!-- Header -->
        <header class="detective-panel p-6 mb-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-purple-600 mb-2">üîç Tier-Detektiv</h1>
                    <p class="text-gray-600">Finde heraus, was dem Tier fehlt!</p>
                </div>
                
                <!-- Difficulty Selector -->
                <div class="difficulty-selector">
                    <button class="difficulty-button active" onclick="setDifficulty('easy')">
                        üåü Anf√§nger
                    </button>
                    <button class="difficulty-button" onclick="setDifficulty('medium')">
                        ‚≠ê‚≠ê Fortgeschritten
                    </button>
                    <button class="difficulty-button" onclick="setDifficulty('hard')">
                        üí´ Experte
                    </button>
                </div>
                
                <!-- Stats -->
                <div class="flex gap-4">
                    <div class="text-center">
                        <div class="text-2xl">üèÜ</div>
                        <div class="font-bold text-yellow-500" id="score">0</div>
                        <div class="text-xs text-gray-500">Punkte</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl">üéØ</div>
                        <div class="font-bold text-green-500" id="correctDiagnoses">0</div>
                        <div class="text-xs text-gray-500">Richtig</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Panel - 3D Model & Examination -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 3D Viewer with Interactive Zones -->
                <div class="detective-panel p-6">
                    <h2 class="text-xl font-bold mb-4">üêï Patient untersuchen</h2>
                    
                    <div class="relative bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl overflow-hidden" style="height: 400px;">
                        <canvas id="canvas3d"></canvas>
                        
                        <!-- Interactive Body Part Buttons -->
                        <button class="body-part-button" id="headBtn" style="top: 20%; left: 70%;" onclick="examineBodyPart('head')">
                            <span class="text-white font-bold">üëÅÔ∏è</span>
                        </button>
                        <button class="body-part-button" id="chestBtn" style="top: 45%; left: 50%;" onclick="examineBodyPart('chest')">
                            <span class="text-white font-bold">‚ù§Ô∏è</span>
                        </button>
                        <button class="body-part-button" id="bellyBtn" style="top: 55%; left: 35%;" onclick="examineBodyPart('belly')">
                            <span class="text-white font-bold">üîç</span>
                        </button>
                        <button class="body-part-button" id="legsBtn" style="top: 75%; left: 45%;" onclick="examineBodyPart('legs')">
                            <span class="text-white font-bold">ü¶¥</span>
                        </button>
                        
                        <!-- Zoom Controls -->
                        <div class="absolute top-4 right-4 flex flex-col gap-2">
                            <button onclick="zoom(1.2)" class="bg-white rounded-lg p-2 shadow hover:bg-gray-100">üîç+</button>
                            <button onclick="zoom(0.8)" class="bg-white rounded-lg p-2 shadow hover:bg-gray-100">üîç-</button>
                            <button onclick="toggleXray()" class="bg-white rounded-lg p-2 shadow hover:bg-gray-100">ü¶¥</button>
                        </div>
                    </div>
                    
                    <!-- Examination Checklist -->
                    <div class="examination-checklist mt-4">
                        <h3 class="font-bold mb-2">üìã Untersuchungs-Checkliste:</h3>
                        <div id="checklistItems">
                            <div class="checklist-item" id="check-head">
                                <div class="checklist-checkbox"></div>
                                <span>Kopf untersuchen (Augen, Ohren, Nase)</span>
                            </div>
                            <div class="checklist-item" id="check-chest">
                                <div class="checklist-checkbox"></div>
                                <span>Brustkorb abh√∂ren (Herz & Lunge)</span>
                            </div>
                            <div class="checklist-item" id="check-belly">
                                <div class="checklist-checkbox"></div>
                                <span>Bauch abtasten</span>
                            </div>
                            <div class="checklist-item" id="check-legs">
                                <div class="checklist-checkbox"></div>
                                <span>Beine & Gelenke pr√ºfen</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Value Comparisons -->
                <div class="detective-panel p-6">
                    <h2 class="text-xl font-bold mb-4">üìä Messwerte vergleichen</h2>
                    
                    <div id="valueComparisons">
                        <!-- Heart Rate -->
                        <div class="value-comparison">
                            <div class="measured-value" id="heartValue">
                                <div class="text-sm text-gray-500">Gemessen</div>
                                <div>-- BPM</div>
                            </div>
                            <div class="text-2xl">‚ù§Ô∏è</div>
                            <div class="normal-value">
                                <div class="text-sm text-gray-500">Normal</div>
                                <div>60-100 BPM</div>
                            </div>
                        </div>
                        
                        <!-- Temperature -->
                        <div class="value-comparison">
                            <div class="measured-value" id="tempValue">
                                <div class="text-sm text-gray-500">Gemessen</div>
                                <div>-- ¬∞C</div>
                            </div>
                            <div class="text-2xl">üå°Ô∏è</div>
                            <div class="normal-value">
                                <div class="text-sm text-gray-500">Normal</div>
                                <div>38.0-39.2 ¬∞C</div>
                            </div>
                        </div>
                        
                        <!-- Breathing -->
                        <div class="value-comparison">
                            <div class="measured-value" id="breathValue">
                                <div class="text-sm text-gray-500">Gemessen</div>
                                <div>-- /min</div>
                            </div>
                            <div class="text-2xl">üí®</div>
                            <div class="normal-value">
                                <div class="text-sm text-gray-500">Normal</div>
                                <div>10-30 /min</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info Box -->
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded mt-4">
                        <p class="text-sm">
                            <span class="font-bold">üí° Wusstest du?</span><br>
                            <span id="funFact">Kleine Tiere haben ein schnelleres Herz als gro√üe! Ein Hamster hat 300-600 Schl√§ge pro Minute!</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - Clues & Diagnosis -->
            <div class="space-y-6">
                <!-- Timeline -->
                <div class="detective-panel p-6">
                    <h3 class="text-lg font-bold mb-4">üìÖ Krankheitsverlauf</h3>
                    <div class="timeline-container">
                        <div class="relative" id="timeline">
                            <div class="timeline-line"></div>
                            <!-- Timeline items will be added dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Collected Clues -->
                <div class="detective-panel p-6">
                    <h3 class="text-lg font-bold mb-4">üîç Gesammelte Hinweise</h3>
                    <div id="cluesList">
                        <p class="text-gray-500 text-sm">Untersuche das Tier, um Hinweise zu sammeln...</p>
                    </div>
                </div>
                
                <!-- Diagnosis Tree -->
                <div class="detective-panel p-6">
                    <h3 class="text-lg font-bold mb-4">üß© Diagnose-Puzzle</h3>
                    <div class="diagnosis-tree" id="diagnosisTree">
                        <div class="text-center text-gray-500">
                            <p>Sammle erst Hinweise!</p>
                            <p class="text-sm mt-2">Dann kannst du hier die Diagnose eingrenzen.</p>
                        </div>
                    </div>
                    
                    <!-- Submit Diagnosis -->
                    <button onclick="submitDiagnosis()" class="w-full mt-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-xl hover:from-purple-600 hover:to-pink-600 transition" id="diagnoseBtn" disabled>
                        üéØ Diagnose stellen
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mentor Character -->
        <div class="mentor-character" id="mentor">
            ü¶â
        </div>
        
        <!-- Mentor Bubble -->
        <div class="mentor-bubble" id="mentorBubble">
            <p id="mentorText">Hallo! Ich bin Dr. Eule. Lass uns zusammen herausfinden, was dem Tier fehlt! Klicke auf die leuchtenden Punkte am Tier, um es zu untersuchen.</p>
        </div>
        
        <!-- Info Tooltip -->
        <div class="info-tooltip" id="tooltip"></div>
    </div>

    <script>
        // Enhanced Game State
        let gameState = {
            difficulty: 'easy',
            score: 0,
            correctDiagnoses: 0,
            currentCase: null,
            examinedParts: [],
            collectedClues: [],
            measurements: {},
            diagnosisPath: [],
            hintsUsed: 0,
            timeStarted: null
        };

        // Medical Cases Database - Now powered by 20-Animals System
        const medicalCases = {
            easy: generate20AnimalCases(), // Generate 60 cases from Level 1 animals
            medium: [
                {
                    id: 'cold',
                    animal: { type: 'Hund', name: 'Bello', age: 5, emoji: 'üêï' },
                    condition: 'Erk√§ltung',
                    timeline: [
                        'Vor 3 Tagen: Erste Nieser',
                        'Vor 2 Tagen: Nasenausfluss',
                        'Heute: M√ºdigkeit'
                    ],
                    symptoms: {
                        head: { 
                            finding: 'Laufende Nase, tr√§nende Augen',
                            visual: 'problem'
                        },
                        chest: { 
                            finding: 'Leichtes Rasseln beim Atmen',
                            visual: 'warning'
                        },
                        belly: { 
                            finding: 'Bauch normal, kein Schmerz',
                            visual: 'normal'
                        },
                        legs: { 
                            finding: 'Bewegung normal',
                            visual: 'normal'
                        }
                    },
                    measurements: {
                        heartRate: { value: 85, status: 'normal' },
                        temperature: { value: 39.5, status: 'warning' },
                        breathing: { value: 22, status: 'normal' }
                    },
                    diagnosis: {
                        correct: 'Erk√§ltung',
                        options: ['Erk√§ltung', 'Allergie', 'Lungenentz√ºndung', 'Grippe'],
                        tree: {
                            'Fieber?': {
                                'Ja': {
                                    'Husten?': {
                                        'Ja': 'Erk√§ltung',
                                        'Nein': 'Grippe'
                                    }
                                },
                                'Nein': {
                                    'Niesen?': {
                                        'Ja': 'Allergie',
                                        'Nein': 'Gesund'
                                    }
                                }
                            }
                        }
                    },
                    hints: [
                        'Achte auf die Temperatur!',
                        'Sind die Atemwege betroffen?',
                        'Wie lange dauern die Symptome schon?'
                    ]
                },
                {
                    id: 'stomach',
                    animal: { type: 'Katze', name: 'Luna', age: 3, emoji: 'üêà' },
                    condition: 'Magenverstimmung',
                    timeline: [
                        'Gestern Abend: Ungew√∂hnliches Futter',
                        'Heute Morgen: Erbrechen',
                        'Jetzt: Appetitlosigkeit'
                    ],
                    symptoms: {
                        head: { 
                            finding: 'M√ºde Augen, aber sonst normal',
                            visual: 'normal'
                        },
                        chest: { 
                            finding: 'Herz und Lunge normal',
                            visual: 'normal'
                        },
                        belly: { 
                            finding: 'Bauch gespannt und empfindlich',
                            visual: 'problem'
                        },
                        legs: { 
                            finding: 'Bewegung langsam, aber m√∂glich',
                            visual: 'warning'
                        }
                    },
                    measurements: {
                        heartRate: { value: 140, status: 'normal' },
                        temperature: { value: 38.5, status: 'normal' },
                        breathing: { value: 20, status: 'normal' }
                    },
                    diagnosis: {
                        correct: 'Magenverstimmung',
                        options: ['Magenverstimmung', 'Vergiftung', 'Darmverschluss', 'Parasiten'],
                        tree: {
                            'Erbrechen?': {
                                'Ja': {
                                    'Fieber?': {
                                        'Nein': 'Magenverstimmung',
                                        'Ja': 'Infektion'
                                    }
                                },
                                'Nein': 'Andere Ursache'
                            }
                        }
                    },
                    hints: [
                        'Was hat das Tier gefressen?',
                        'Ist der Bauch hart?',
                        'Gibt es Fieber?'
                    ]
                }
            ],
            medium: [
                // More complex cases
            ],
            hard: [
                // Expert level cases
            ]
        };

        // Fun facts database
        // Fun Facts now powered by our educational database
        const funFacts = [
            // From our 20-animals educational system
            ...Object.values(ANIMAL_EDUCATION).flatMap(animal => animal.funFacts),
            // Additional general facts
            "Kleine Tiere haben ein schnelleres Herz als gro√üe!",
            "Jedes Tier hat seine eigenen normalen Vitalwerte!",
            "Tier√§rzte m√ºssen √ºber 20 verschiedene Tierarten kennen!",
            "Ein guter Tierarzt h√∂rt dem Tierbesitzer genau zu!"
        ];

        // 3D Scene variables
        let scene, camera, renderer, animalModel;
        let isXrayMode = false;
        
        // Initialize 3D Scene
        function init3D() {
            const canvas = document.getElementById('canvas3d');
            const container = canvas.parentElement;
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f9ff);
            
            camera = new THREE.PerspectiveCamera(
                75,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            camera.position.set(0, 2, 5);
            
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                antialias: true,
                alpha: true 
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            
            // Enhanced lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            scene.add(directionalLight);
            
            // Create enhanced animal model
            createEnhancedAnimalModel();
            
            // Mouse controls
            setupMouseControls();
            
            animate();
        }
        
        function createEnhancedAnimalModel() {
            const group = new THREE.Group();
            
            // Body with better geometry
            const bodyGeometry = new THREE.BoxGeometry(2.5, 1.2, 1.2);
            const bodyMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x8b4513,
                emissive: 0x442211,
                shininess: 30
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            group.add(body);
            
            // Head
            const headGeometry = new THREE.SphereGeometry(0.5, 16, 16);
            const head = new THREE.Mesh(headGeometry, bodyMaterial);
            head.position.set(1.5, 0.3, 0);
            group.add(head);
            
            // Ears
            const earGeometry = new THREE.ConeGeometry(0.15, 0.3, 4);
            const leftEar = new THREE.Mesh(earGeometry, bodyMaterial);
            leftEar.position.set(1.4, 0.7, 0.2);
            group.add(leftEar);
            
            const rightEar = new THREE.Mesh(earGeometry, bodyMaterial);
            rightEar.position.set(1.4, 0.7, -0.2);
            group.add(rightEar);
            
            // Legs
            const legGeometry = new THREE.CylinderGeometry(0.15, 0.15, 1);
            const legMaterial = new THREE.MeshPhongMaterial({ color: 0x654321 });
            
            for (let i = 0; i < 4; i++) {
                const leg = new THREE.Mesh(legGeometry, legMaterial);
                const x = i < 2 ? 0.8 : -0.8;
                const z = i % 2 === 0 ? 0.4 : -0.4;
                leg.position.set(x, -0.8, z);
                group.add(leg);
            }
            
            // Tail
            const tailGeometry = new THREE.ConeGeometry(0.2, 1, 8);
            const tail = new THREE.Mesh(tailGeometry, bodyMaterial);
            tail.position.set(-1.5, 0, 0);
            tail.rotation.z = -Math.PI / 3;
            group.add(tail);
            
            animalModel = group;
            scene.add(animalModel);
        }
        
        function setupMouseControls() {
            let mouseDown = false;
            let mouseX = 0;
            let mouseY = 0;
            
            const canvas = renderer.domElement;
            
            canvas.addEventListener('mousedown', (e) => {
                mouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!mouseDown || !animalModel) return;
                
                const deltaX = e.clientX - mouseX;
                const deltaY = e.clientY - mouseY;
                
                animalModel.rotation.y += deltaX * 0.01;
                animalModel.rotation.x += deltaY * 0.01;
                
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            canvas.addEventListener('mouseup', () => {
                mouseDown = false;
            });
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            if (animalModel && !isXrayMode) {
                animalModel.rotation.y += 0.002;
            }
            
            renderer.render(scene, camera);
        }
        
        function zoom(factor) {
            camera.position.z *= factor;
            camera.position.z = Math.max(2, Math.min(10, camera.position.z));
        }
        
        function toggleXray() {
            isXrayMode = !isXrayMode;
            
            if (animalModel) {
                animalModel.traverse((child) => {
                    if (child.isMesh) {
                        if (isXrayMode) {
                            child.material = new THREE.MeshBasicMaterial({
                                color: 0x00ff00,
                                wireframe: true,
                                opacity: 0.3,
                                transparent: true
                            });
                        } else {
                            child.material = new THREE.MeshPhongMaterial({
                                color: child.userData.originalColor || 0x8b4513
                            });
                        }
                    }
                });
            }
        }
        
        // Examination Functions
        function examineBodyPart(part) {
            if (!gameState.currentCase) return;
            
            if (gameState.examinedParts.includes(part)) {
                showMentorMessage('Du hast diesen Bereich schon untersucht!');
                return;
            }
            
            gameState.examinedParts.push(part);
            const symptom = gameState.currentCase.symptoms[part];
            
            // Update button visual
            const btn = document.getElementById(part + 'Btn');
            btn.classList.add('examined');
            if (symptom.visual === 'problem') {
                btn.classList.add('problem');
            }
            
            // Add clue
            addClue(symptom.finding, symptom.visual);
            
            // Update checklist
            document.getElementById('check-' + part).classList.add('completed');
            const checkbox = document.querySelector(`#check-${part} .checklist-checkbox`);
            checkbox.innerHTML = '‚úì';
            
            // Show measurements after chest examination
            if (part === 'chest') {
                revealMeasurements();
            }
            
            // Update score
            gameState.score += 10;
            updateUI();
            
            // Check if enough clues collected
            if (gameState.examinedParts.length >= 2) {
                enableDiagnosisTree();
            }
            
            // Mentor feedback
            if (gameState.difficulty === 'easy') {
                provideMentorHint(part);
            }
        }
        
        function addClue(finding, severity) {
            const clue = {
                text: finding,
                severity: severity,
                timestamp: new Date().toLocaleTimeString()
            };
            
            gameState.collectedClues.push(clue);
            
            const cluesList = document.getElementById('cluesList');
            const clueCard = document.createElement('div');
            clueCard.className = 'clue-card';
            clueCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${finding}</span>
                    ${severity === 'problem' ? '<span class="text-red-500">‚ö†Ô∏è</span>' : 
                      severity === 'warning' ? '<span class="text-yellow-500">‚ö°</span>' : 
                      '<span class="text-green-500">‚úì</span>'}
                </div>
                <div class="text-xs text-gray-500 mt-1">${clue.timestamp}</div>
            `;
            
            if (cluesList.children[0].classList.contains('text-gray-500')) {
                cluesList.innerHTML = '';
            }
            cluesList.appendChild(clueCard);
        }
        
        function revealMeasurements() {
            const measurements = gameState.currentCase.measurements;
            
            // Heart Rate
            const heartValue = document.getElementById('heartValue');
            heartValue.innerHTML = `
                <div class="text-sm text-gray-500">Gemessen</div>
                <div>${measurements.heartRate.value} BPM</div>
            `;
            heartValue.className = 'measured-value value-status-' + measurements.heartRate.status;
            
            // Temperature
            const tempValue = document.getElementById('tempValue');
            tempValue.innerHTML = `
                <div class="text-sm text-gray-500">Gemessen</div>
                <div>${measurements.temperature.value} ¬∞C</div>
            `;
            tempValue.className = 'measured-value value-status-' + measurements.temperature.status;
            
            // Breathing
            const breathValue = document.getElementById('breathValue');
            breathValue.innerHTML = `
                <div class="text-sm text-gray-500">Gemessen</div>
                <div>${measurements.breathing.value} /min</div>
            `;
            breathValue.className = 'measured-value value-status-' + measurements.breathing.status;
            
            // Add measurement clues
            if (measurements.temperature.status === 'warning') {
                addClue('Erh√∂hte Temperatur festgestellt', 'warning');
            }
            if (measurements.heartRate.status === 'warning') {
                addClue('Herzfrequenz au√üerhalb Normalbereich', 'warning');
            }
        }
        
        function enableDiagnosisTree() {
            const tree = document.getElementById('diagnosisTree');
            const currentCase = gameState.currentCase;
            
            tree.innerHTML = `
                <p class="text-sm text-gray-600 mb-3">Klicke auf die Optionen, um die Diagnose einzugrenzen:</p>
                <div class="space-y-2">
                    ${currentCase.diagnosis.options.map(option => `
                        <div class="tree-node" onclick="selectDiagnosis('${option}')">
                            ${option}
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('diagnoseBtn').disabled = false;
            showMentorMessage('Gut! Du hast genug Hinweise gesammelt. Welche Diagnose passt zu den Symptomen?');
        }
        
        function selectDiagnosis(diagnosis) {
            // Toggle selection
            const nodes = document.querySelectorAll('.tree-node');
            nodes.forEach(node => {
                if (node.textContent.trim() === diagnosis) {
                    node.classList.toggle('selected');
                } else {
                    node.classList.remove('selected');
                }
            });
            
            gameState.selectedDiagnosis = diagnosis;
        }
        
        function submitDiagnosis() {
            if (!gameState.selectedDiagnosis) {
                showMentorMessage('W√§hle erst eine Diagnose aus!');
                return;
            }
            
            const correct = gameState.selectedDiagnosis === gameState.currentCase.diagnosis.correct;
            
            if (correct) {
                gameState.correctDiagnoses++;
                gameState.score += 100;
                showMentorMessage('üéâ Richtig! Das Tier hat ' + gameState.currentCase.condition + '! Super gemacht!');
                
                // Show success animation
                confetti();
                
                // Load next case after delay
                setTimeout(loadNewCase, 3000);
            } else {
                gameState.score = Math.max(0, gameState.score - 20);
                showMentorMessage('Hmm, das stimmt nicht. Schau dir die Symptome nochmal genau an!');
                
                // Provide hint
                if (gameState.hintsUsed < gameState.currentCase.hints.length) {
                    setTimeout(() => {
                        showMentorMessage('Tipp: ' + gameState.currentCase.hints[gameState.hintsUsed]);
                        gameState.hintsUsed++;
                    }, 2000);
                }
            }
            
            updateUI();
        }
        
        function provideMentorHint(part) {
            const hints = {
                'head': 'Gut! Schau dir Augen und Nase genau an.',
                'chest': 'Perfekt! Jetzt siehst du die wichtigen Vitalwerte.',
                'belly': 'Ist der Bauch hart oder weich? Das ist wichtig!',
                'legs': 'Kann das Tier normal laufen?'
            };
            
            showMentorMessage(hints[part]);
        }
        
        function showMentorMessage(message) {
            const bubble = document.getElementById('mentorBubble');
            const text = document.getElementById('mentorText');
            
            text.textContent = message;
            bubble.style.animation = 'none';
            setTimeout(() => {
                bubble.style.animation = 'bounceIn 0.5s ease';
            }, 10);
        }
        
        function setDifficulty(level) {
            gameState.difficulty = level;
            
            // Update buttons
            document.querySelectorAll('.difficulty-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Adjust mentor help
            if (level === 'easy') {
                document.getElementById('mentor').style.display = 'block';
                document.getElementById('mentorBubble').style.display = 'block';
            } else if (level === 'medium') {
                document.getElementById('mentor').style.display = 'block';
                document.getElementById('mentorBubble').style.display = 'none';
            } else {
                document.getElementById('mentor').style.display = 'none';
                document.getElementById('mentorBubble').style.display = 'none';
            }
            
            loadNewCase();
        }
        
        function loadNewCase() {
            // Reset state
            gameState.examinedParts = [];
            gameState.collectedClues = [];
            gameState.selectedDiagnosis = null;
            gameState.hintsUsed = 0;
            gameState.timeStarted = Date.now();
            
            // Load random case
            const cases = medicalCases[gameState.difficulty] || medicalCases.easy;
            gameState.currentCase = cases[Math.floor(Math.random() * cases.length)];
            
            // Reset UI
            resetUI();
            
            // Load timeline
            loadTimeline();
            
            // Show new patient info
            showMentorMessage(`Ein neuer Patient! ${gameState.currentCase.animal.name} ${gameState.currentCase.animal.emoji} braucht deine Hilfe!`);
            
            // Update fun fact
            document.getElementById('funFact').textContent = funFacts[Math.floor(Math.random() * funFacts.length)];
        }
        
        function loadTimeline() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '<div class="timeline-line"></div>';
            
            gameState.currentCase.timeline.forEach((event, index) => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.style.position = 'relative';
                item.innerHTML = `
                    <div class="timeline-dot"></div>
                    <div class="ml-6">
                        <p class="text-sm text-gray-600">${event}</p>
                    </div>
                `;
                timeline.appendChild(item);
            });
        }
        
        function resetUI() {
            // Reset examination buttons
            document.querySelectorAll('.body-part-button').forEach(btn => {
                btn.classList.remove('examined', 'problem');
            });
            
            // Reset checklist
            document.querySelectorAll('.checklist-item').forEach(item => {
                item.classList.remove('completed');
                item.querySelector('.checklist-checkbox').innerHTML = '';
            });
            
            // Reset measurements
            document.getElementById('heartValue').innerHTML = '<div class="text-sm text-gray-500">Gemessen</div><div>-- BPM</div>';
            document.getElementById('tempValue').innerHTML = '<div class="text-sm text-gray-500">Gemessen</div><div>-- ¬∞C</div>';
            document.getElementById('breathValue').innerHTML = '<div class="text-sm text-gray-500">Gemessen</div><div>-- /min</div>';
            
            // Reset clues
            document.getElementById('cluesList').innerHTML = '<p class="text-gray-500 text-sm">Untersuche das Tier, um Hinweise zu sammeln...</p>';
            
            // Reset diagnosis tree
            document.getElementById('diagnosisTree').innerHTML = `
                <div class="text-center text-gray-500">
                    <p>Sammle erst Hinweise!</p>
                    <p class="text-sm mt-2">Dann kannst du hier die Diagnose eingrenzen.</p>
                </div>
            `;
            
            document.getElementById('diagnoseBtn').disabled = true;
        }
        
        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('correctDiagnoses').textContent = gameState.correctDiagnoses;
        }
        
        function confetti() {
            // Simple confetti effect
            const colors = ['#fbbf24', '#34d399', '#60a5fa', '#f87171', '#a78bfa'];
            for (let i = 0; i < 50; i++) {
                const confetto = document.createElement('div');
                confetto.style.position = 'fixed';
                confetto.style.width = '10px';
                confetto.style.height = '10px';
                confetto.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetto.style.left = Math.random() * 100 + '%';
                confetto.style.top = '-10px';
                confetto.style.borderRadius = '50%';
                confetto.style.zIndex = '9999';
                document.body.appendChild(confetto);
                
                // Animate
                let pos = -10;
                const fall = setInterval(() => {
                    pos += 5;
                    confetto.style.top = pos + 'px';
                    confetto.style.transform = `translateX(${Math.sin(pos/10) * 20}px) rotate(${pos * 2}deg)`;
                    
                    if (pos > window.innerHeight) {
                        clearInterval(fall);
                        confetto.remove();
                    }
                }, 30);
            }
        }
        
        // Initialize game
        window.addEventListener('load', () => {
            init3D();
            loadNewCase();
            updateUI();
            
            // Show initial mentor message
            if (gameState.difficulty === 'easy') {
                showMentorMessage('Willkommen beim Tier-Detektiv! Klicke auf die leuchtenden Punkte am Tier, um es zu untersuchen. Sammle Hinweise und finde heraus, was dem Tier fehlt!');
            }
        });
        
        // Save game progress
        setInterval(() => {
            localStorage.setItem('vetDetectiveState', JSON.stringify(gameState));
        }, 5000);
    </script>
</body>
</html>